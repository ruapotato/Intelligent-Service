{% extends "layout.html" %}
{% block title %}Ticket #{{ ticket.id }}{% endblock %}

{% block content %}
    <h1>{{ ticket.subject }}</h1>
    <div class="ticket-details">
        <p><strong>Company:</strong> <a href="{{ url_for('edit_company', company_id=ticket.company_id) }}">{{ ticket.company_name }}</a></p>
        <p><strong>User:</strong> <a href="{{ url_for('edit_user', user_id=ticket.user_id) }}">{{ ticket.user_username }}</a></p>
        <p><strong>Status:</strong> {{ ticket.status }}</p>
        <p><strong>Created:</strong> {{ ticket.created_at }}</p>
    </div>

    <div class="replies-section">
        <h2>Replies</h2>
        {% for reply in replies %}
            <div class="reply">
                <p class="reply-meta">Reply from {{ reply.author_name or 'Client' }} on {{ reply.created_at }}</p>
                <div class="reply-content">
                    {{ reply.content }}
                </div>
            </div>
        {% endfor %}
    </div>

    {% if current_user.role in ['Admin', 'Technician'] %}
    <div class="reply-form">
        <h2>Add a Reply</h2>
        <form method="POST" action="{{ url_for('add_reply', ticket_id=ticket.id) }}">
            <textarea name="content" rows="5" placeholder="Type your reply here..."></textarea>
            <button type="submit">Add Reply</button>
        </form>
    </div>
    {% endif %}

    <div class="ai-tools">
        <h2>AI Tools</h2>
        <button id="summarize-btn">Summarize Ticket</button>
        <button id="sanitize-btn">Sanitize for Export</button>
        <div id="ai-output"></div>
        <hr>
        <h3>Full Context (for AI)</h3>
        <pre class="audit-details" id="full-context-display"></pre>
    </div>

    <div class="chat-container">
        <h2>AI Chat</h2>
        <div id="chat-box"></div>
        <input type="text" id="chat-input" placeholder="Ask a question about this ticket...">
        <button id="chat-send">Send</button>
    </div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const summarizeBtn = document.getElementById('summarize-btn');
    const sanitizeBtn = document.getElementById('sanitize-btn');
    const aiOutput = document.getElementById('ai-output');
    const fullContextDisplay = document.getElementById('full-context-display');
    
    const companyNotes = {{ company_notes | tojson }};
    const userNotes = {{ user_notes | tojson }};

    function getTicketText() {
        return Array.from(document.querySelectorAll('.reply-content')).map(el => el.innerText).join('\n\n');
    }

    function getFullContext() {
        const ticketContent = getTicketText();
        const companyNotesText = companyNotes.map(note => note.content).join('\n');
        const userNotesText = userNotes.map(note => note.content).join('\n');
        return `COMPANY CONTEXT:\n${companyNotesText}\n\nUSER CONTEXT:\n${userNotesText}\n\nTICKET CONTENT:\n${ticketContent}`;
    }

    fullContextDisplay.textContent = getFullContext();

    summarizeBtn.addEventListener('click', function() {
        const fullContext = getFullContext();
        fetch('/summarize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: fullContext })
        }).then(res => res.json()).then(data => {
            aiOutput.innerHTML = `<h3>Summary:</h3><p>${data.summary}</p>`;
        });
    });

    sanitizeBtn.addEventListener('click', function() {
        const ticketContent = getTicketText();
        fetch('/sanitize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: ticketContent })
        }).then(res => res.json()).then(data => {
            aiOutput.innerHTML = `<h3>Sanitized Text:</h3><textarea rows="10" readonly>${data.sanitized}</textarea><button onclick="copyToClipboard()">Copy</button>`;
        });
    });

    const chatBox = document.getElementById('chat-box');
    const chatInput = document.getElementById('chat-input');
    const chatSendBtn = document.getElementById('chat-send');

    chatSendBtn.addEventListener('click', function() {
        const userMessage = chatInput.value;
        if (!userMessage) return;

        appendMessage('You', userMessage);
        chatInput.value = '';

        const fullContext = getFullContext();

        fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ context: fullContext, question: userMessage })
        }).then(res => res.json()).then(data => {
            appendMessage('AI', data.response);
        });
    });

    function appendMessage(sender, message) {
        const messageElement = document.createElement('div');
        messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
});

function copyToClipboard() {
    const textarea = document.querySelector('#ai-output textarea');
    textarea.select();
    document.execCommand('copy');
    alert('Copied to clipboard!');
}
</script>
{% endblock %}
